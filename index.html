<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Collection de Cartes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gold-card {
            background-color: #fef3c7;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-2xl font-bold text-center mb-4">Gestionnaire de Collection de Cartes</h1>
        
        <!-- Boutons principaux avec description -->
        <div class="flex gap-4 justify-center mb-2">
            <button id="saveButton" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Sauvegarder</button>
            <button id="loadButton" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Charger</button>
        </div>
        <div class="flex flex-col items-center mb-4">
            <div class="flex gap-4 justify-center">
                <button id="exportDataBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                    Transférer vers autre appareil
                </button>
                <button id="importDataBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded">
                    Importer depuis autre appareil
                </button>
            </div>
            <div class="text-xs text-gray-500 mt-1">
                Ces boutons permettent de transférer toutes vos données vers un autre appareil ou navigateur
            </div>
        </div>
        
        <!-- Configuration des comptes -->
        <div class="bg-white p-4 rounded shadow mb-4">
            <h2 class="text-xl font-bold mb-2">Configuration des Comptes</h2>
            <div id="accountsList" class="mb-2">
                <!-- Les comptes seront affichés ici -->
            </div>
            <div class="flex gap-2">
                <input type="text" id="newAccountName" placeholder="Nom du nouveau compte" 
                       class="border rounded px-2 py-1 flex-grow">
                <button id="addAccountBtn" class="bg-blue-500 text-white px-3 py-1 rounded">
                    Ajouter Compte
                </button>
            </div>
        </div>
        
        <!-- Boutons de copie/import par compte -->
        <div id="accountButtons" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 mb-4">
            <!-- Les boutons seront générés ici -->
        </div>
        
        <!-- Statistiques -->
        <div class="mb-4">
            <h2 class="text-xl font-bold mb-2">Statistiques</h2>
            <div id="statistics" class="bg-white p-4 rounded shadow">
                <!-- Les statistiques seront affichées ici -->
            </div>
        </div>
        
        <!-- Filtres -->
        <div class="bg-white p-4 rounded shadow mb-4">
            <h2 class="text-xl font-bold mb-2">Filtres</h2>
            <div class="flex flex-wrap gap-2">
                <button id="filterAll" class="filter-btn px-3 py-1 rounded text-white bg-blue-500">
                    Toutes les cartes
                </button>
                <button id="filterExchangeable" class="filter-btn px-3 py-1 rounded text-white bg-gray-500">
                    Échanges possibles
                </button>
                <button id="filterMissing" class="filter-btn px-3 py-1 rounded text-white bg-gray-500">
                    Cartes manquantes
                </button>
            </div>
        </div>
        
        <!-- Informations sur les cartes -->
        <div class="mb-2">
            <p id="cardsInfo" class="text-sm text-gray-600"></p>
        </div>
        
        <!-- Tableau des cartes -->
        <div class="bg-white rounded shadow overflow-auto mb-4">
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-100 border-b">
                        <th class="py-2 px-3 text-left">Nom</th>
                        <!-- Les en-têtes des comptes seront générés dynamiquement -->
                    </tr>
                </thead>
                <tbody id="cardsTable">
                    <!-- Les cartes seront affichées ici -->
                </tbody>
            </table>
        </div>
    
    </div>
    
    <script>
        // Variables globales
        let cards = [];
        let accounts = [];
        let currentFilter = 'all'; // Valeurs possibles: 'all', 'exchangeable', 'missing'
        
        // Fonction pour initialiser le stockage avec des valeurs par défaut si nécessaire
        function initializeStorage() {
            if (!localStorage.getItem('cardsManagerAccounts')) {
                // Configuration par défaut: 2 comptes
                const defaultAccounts = ["Compte 1", "Compte 2"];
                localStorage.setItem('cardsManagerAccounts', JSON.stringify(defaultAccounts));
            }
        }

        // Fonction pour charger les comptes depuis le stockage local
        function loadAccounts() {
            initializeStorage();
            return JSON.parse(localStorage.getItem('cardsManagerAccounts'));
        }

        // Fonction pour sauvegarder les comptes dans le stockage local
        function saveAccounts(accounts) {
            localStorage.setItem('cardsManagerAccounts', JSON.stringify(accounts));
        }

        // Fonction pour ajouter un nouveau compte
        function addAccount(name) {
            const accounts = loadAccounts();
            accounts.push(name);
            saveAccounts(accounts);
            return accounts;
        }

        // Fonction pour supprimer un compte
        function removeAccount(index) {
            const accounts = loadAccounts();
            // Vérifier qu'au moins un compte reste
            if (accounts.length <= 1) {
                alert("Vous devez garder au moins un compte.");
                return accounts;
            }
            
            // Supprimer le compte
            accounts.splice(index, 1);
            
            // Supprimer les quantités associées à ce compte
            cards = cards.map(card => {
                const newQuantities = card.quantities.filter((_, i) => i !== index);
                return { ...card, quantities: newQuantities };
            });
            
            saveAccounts(accounts);
            saveData(); // Sauvegarder aussi les cartes modifiées
            return accounts;
        }

        // Fonction pour renommer un compte
        function renameAccount(index, newName) {
            const accounts = loadAccounts();
            accounts[index] = newName;
            saveAccounts(accounts);
            return accounts;
        }

        // Fonction d'initialisation
        function init() {
            console.log("Initialisation de l'application...");
            
            // Tenter de migrer les anciennes données si elles existent
            migrateOldData();
            
            // Charger les comptes
            accounts = loadAccounts();
            
            // Charger les données sauvegardées ou initialiser
            const savedData = localStorage.getItem('cardsManagerData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    cards = data.cards;
                    
                    // Vérifier si le nombre de comptes a changé
                    if (cards.length > 0 && cards[0].quantities.length !== accounts.length) {
                        // Ajuster les quantités au nouveau nombre de comptes
                        adjustQuantities();
                    }
                    
                    console.log("Données chargées depuis le stockage local:", cards.length, "cartes");
                } catch (e) {
                    console.error("Erreur lors du chargement des données:", e);
                    initializeDefaultData();
                }
            } else {
                console.log("Aucune donnée sauvegardée trouvée, initialisation des valeurs par défaut...");
                initializeDefaultData();
            }

            // Afficher les comptes
            renderAccounts();
            
            // Initialiser les boutons de compte
            renderAccountButtons();
            
            // Afficher les cartes
            renderCards();
            
            // Mettre à jour les statistiques
            updateStatistics();
            
            // Ajouter la légende pour les échanges
            renderLegend();
            
            // Ajouter les écouteurs d'événements
            addEventListeners();
        }

        // Fonction pour migrer les anciennes données au nouveau format
        function migrateOldData() {
            // Vérifier si nous avons déjà des comptes configurés
            if (localStorage.getItem('cardsManagerAccounts')) {
                return; // Déjà migré
            }
            
            // Essayer de migrer depuis l'ancien format si existant
            if (localStorage.getItem('monopolyAccounts')) {
                try {
                    const oldAccounts = JSON.parse(localStorage.getItem('monopolyAccounts'));
                    localStorage.setItem('cardsManagerAccounts', JSON.stringify(oldAccounts));
                    console.log("Migration réussie des comptes depuis l'ancien format");
                    
                    // Migrer aussi les données des cartes si elles existent
                    if (localStorage.getItem('monopolyData')) {
                        localStorage.setItem('cardsManagerData', localStorage.getItem('monopolyData'));
                        console.log("Migration réussie des données des cartes depuis l'ancien format");
                    }
                } catch (e) {
                    console.error("Erreur pendant la migration:", e);
                }
            }
        }

        // Fonction pour ajuster les quantités si le nombre de comptes change
        function adjustQuantities() {
            cards = cards.map(card => {
                let newQuantities = [...card.quantities];
                
                // Si le nombre de comptes a augmenté, ajouter des zéros
                while (newQuantities.length < accounts.length) {
                    newQuantities.push(0);
                }
                
                // Si le nombre de comptes a diminué, tronquer
                if (newQuantities.length > accounts.length) {
                    newQuantities = newQuantities.slice(0, accounts.length);
                }
                
                return { ...card, quantities: newQuantities };
            });
        }

        // Fonction pour initialiser les données par défaut
        function initializeDefaultData() {
            // S'assurer que cardsData est défini
            if (typeof cardsData === 'undefined') {
                // Créer des données d'exemple si cardsData n'est pas disponible
                cardsData = Array.from({ length: 36 }, (_, i) => ({
                    id: i + 1,
                    name: `Carte ${i + 1}`,
                    stars: (i % 3) + 1,
                    isGold: i % 10 === 0
                }));
            }
            
            cards = cardsData.map(card => {
                // Créer un tableau de quantités avec un zéro par compte
                const quantities = new Array(accounts.length).fill(0);
                return { ...card, quantities };
            });
        }

        // Fonction pour afficher la liste des comptes
        function renderAccounts() {
            const container = document.getElementById('accountsList');
            container.innerHTML = '';
            
            accounts.forEach((account, index) => {
                const accountDiv = document.createElement('div');
                accountDiv.className = 'flex items-center justify-between p-2 border-b';
                accountDiv.innerHTML = `
                    <span class="flex-grow">${account}</span>
                    <div class="flex gap-2">
                        <button class="rename-account-btn bg-yellow-500 text-white px-2 py-1 rounded text-xs" 
                                data-index="${index}">
                            Renommer
                        </button>
                        <button class="remove-account-btn bg-red-500 text-white px-2 py-1 rounded text-xs" 
                                data-index="${index}">
                            Supprimer
                        </button>
                    </div>
                `;
                container.appendChild(accountDiv);
            });
            
            // Ajouter les écouteurs d'événements pour les boutons
            document.querySelectorAll('.rename-account-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const newName = prompt('Nouveau nom de compte:', accounts[index]);
                    if (newName && newName.trim() !== '') {
                        accounts = renameAccount(index, newName.trim());
                        renderAccounts();
                        renderAccountButtons();
                        renderCards();
                        updateStatistics();
                    }
                });
            });
            
            document.querySelectorAll('.remove-account-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    if (confirm(`Êtes-vous sûr de vouloir supprimer le compte "${accounts[index]}"?`)) {
                        accounts = removeAccount(index);
                        renderAccounts();
                        renderAccountButtons();
                        renderCards();
                        updateStatistics();
                    }
                });
            });
        }

        // Fonction pour afficher les boutons de compte
        function renderAccountButtons() {
            const container = document.getElementById('accountButtons');
            container.innerHTML = '';
            
            accounts.forEach((account, index) => {
                const div = document.createElement('div');
                div.className = 'mb-2';
                div.innerHTML = `
                    <div class="text-sm font-medium mb-1">${account}</div>
                    <div class="flex gap-2">
                        <button class="copy-btn bg-blue-500 text-white px-2 py-1 rounded text-xs" 
                                data-account-index="${index}">Copier quantités</button>
                        <button class="import-btn bg-green-500 text-white px-2 py-1 rounded text-xs" 
                                data-account-index="${index}">Importer quantités</button>
                    </div>
                `;
                container.appendChild(div);
            });
            
            // Ajouter les écouteurs d'événements
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const accountIndex = parseInt(this.getAttribute('data-account-index'));
                    copyAccount(accountIndex);
                });
            });
            
            document.querySelectorAll('.import-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const accountIndex = parseInt(this.getAttribute('data-account-index'));
                    importAccount(accountIndex);
                });
            });
        }

        // Fonction pour copier les quantités de compte - format une ligne par valeur
        function copyAccount(accountIndex) {
            // Commencer par "Quantity" pour indiquer le format
            let quantitiesText = "Quantity\n";
            
            // Ajouter chaque quantité sur une nouvelle ligne
            cards.forEach(card => {
                quantitiesText += card.quantities[accountIndex] + "\n";
            });
            
            navigator.clipboard.writeText(quantitiesText)
                .then(() => {
                    alert(`Données de ${accounts[accountIndex]} copiées dans le presse-papier.`);
                })
                .catch(err => {
                    console.error('Erreur lors de la copie des données:', err);
                    alert('Erreur lors de la copie des données.');
                });
        }

        // Fonction pour importer les quantités de compte - format une ligne par valeur
        function importAccount(accountIndex) {
            const input = prompt(`Collez les données à importer pour ${accounts[accountIndex]}`);
            if (!input || input.trim() === "") {
                alert("Aucune donnée fournie.");
                return;
            }
            
            try {
                // Diviser l'entrée par sauts de ligne
                let lines = input.split(/\r?\n/);
                
                // Supprimer le mot "Quantity" s'il est présent dans la première ligne
                if (lines.length > 0 && lines[0].trim().toLowerCase() === "quantity") {
                    lines = lines.slice(1);
                }
                
                // Filtrer les lignes vides et convertir en nombres
                const quantities = lines
                    .map(line => line.trim())
                    .filter(line => line !== "")
                    .map(line => parseInt(line, 10))
                    .filter(num => !isNaN(num));
                
                console.log("Quantités détectées:", quantities);
                
                if (quantities.length === 0) {
                    alert("Aucune quantité valide trouvée.");
                    return;
                }
                
                let importCount = 0;
                
                // Traiter chaque quantité et l'assigner à la carte correspondante
                for (let i = 0; i < Math.min(quantities.length, cards.length); i++) {
                    cards[i].quantities[accountIndex] = quantities[i];
                    importCount++;
                }
                
                if (importCount > 0) {
                    alert(`Importation réussie: ${importCount} cartes mises à jour pour ${accounts[accountIndex]}.`);
                    renderCards();
                    updateStatistics();
                    saveData(); // Sauvegarder les modifications
                } else {
                    alert("Aucune carte n'a pu être importée.");
                }
                
            } catch (e) {
                console.error('Erreur pendant l\'importation:', e);
                alert('Erreur pendant l\'importation: ' + e.message);
            }
        }

        // Mise à jour de l'affichage des cartes pour prendre en compte un nombre variable de comptes
        function renderCards() {
            console.log("Rendu des cartes...", cards.length, "cartes à afficher");
            
            const tbody = document.getElementById('cardsTable');
            tbody.innerHTML = '';
            
            // Mettre à jour l'en-tête du tableau pour afficher tous les comptes
            const thead = document.querySelector('thead tr');
            thead.innerHTML = `
                <th class="py-2 px-3 text-left">Nom</th>
                ${accounts.map(account => `<th class="py-2 px-3 text-center">${account}</th>`).join('')}
            `;
            
            // Filtrer les cartes selon le filtre actif
            let filteredCards = [...cards]; // Par défaut, toutes les cartes
            
            if (currentFilter === 'exchangeable') {
                // Cartes où au moins un compte a des exemplaires en trop (>1) 
                // et au moins un autre compte en a besoin (=0)
                filteredCards = cards.filter(card => {
                    const hasExtraInSomeAccount = card.quantities.some(qty => qty > 1);
                    const isMissingInSomeAccount = card.quantities.some(qty => qty === 0);
                    return hasExtraInSomeAccount && isMissingInSomeAccount;
                });
            } else if (currentFilter === 'missing') {
                // Cartes manquantes dans au moins un compte
                filteredCards = cards.filter(card => {
                    return card.quantities.some(qty => qty === 0);
                });
            }
            
            // Afficher les cartes filtrées
            filteredCards.forEach(card => {
                const tr = document.createElement('tr');
                tr.className = `border-t hover:bg-gray-50 ${card.isGold ? 'gold-card' : ''}`;
                
                // Calculer le numéro d'ensemble
                const setNumber = Math.floor((card.id - 1) / 9) + 1;
                
                // Cellule du nom avec numéro d'ensemble, nom, et étoiles
                let html = `
                    <td class="py-2 px-3">
                        <span class="inline-block bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-xs font-bold mr-2">Ens. ${setNumber}</span>
                        ${card.name} 
                        ${card.isGold ? 
                            '<span class="inline-block bg-yellow-200 text-yellow-800 px-2 py-1 rounded text-xs font-bold mx-1">OR</span>' : 
                            ''
                        }
                        <span class="text-yellow-500">${'⭐'.repeat(card.stars)}</span>
                    </td>
                `;
                
                // Ajouter une cellule pour chaque compte
                accounts.forEach((_, accountIndex) => {
                    // Vérifier s'il peut y avoir des échanges
                    let accountClass = '';
                    let exchangeIndicator = '';
                    
                    // Détecter les possibilités d'échange
                    const hasExtra = card.quantities[accountIndex] > 1;
                    
                    // Vérifier si d'autres comptes ont besoin de cette carte
                    const otherAccountsNeed = accounts.some((_, otherIndex) => 
                        otherIndex !== accountIndex && card.quantities[otherIndex] === 0
                    );
                    
                    if (hasExtra && otherAccountsNeed) {
                        accountClass = 'bg-green-100 border-green-300 border';
                        exchangeIndicator = '<span class="inline-block ml-1 text-green-600 text-xs">⟷</span>';
                    }
                    
                    const needsCard = card.quantities[accountIndex] === 0;
                    const otherAccountsHaveExtra = accounts.some((_, otherIndex) => 
                        otherIndex !== accountIndex && card.quantities[otherIndex] > 1
                    );
                    
                    if (needsCard && otherAccountsHaveExtra) {
                        accountClass = 'bg-blue-100 border-blue-300 border';
                    }
                    
                    html += `
                        <td class="py-2 px-3 text-center ${accountClass}">
                            <input type="number" min="0" class="quantity-input w-12 text-center border rounded" 
                                data-card-id="${card.id}" data-account-index="${accountIndex}" value="${card.quantities[accountIndex]}">
                            ${exchangeIndicator}
                        </td>
                    `;
                });
                
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
            
            // Mettre à jour le nombre de cartes affichées
            const totalCards = cards.length;
            const displayedCards = filteredCards.length;
            
            let infoText = `Total des cartes: ${totalCards} (dont ${cards.filter(c => c.isGold).length} cartes OR)`;
            if (currentFilter !== 'all') {
                infoText += ` | Affichées: ${displayedCards}`;
            }
            
            document.getElementById('cardsInfo').textContent = infoText;
            
            // Ajouter les écouteurs d'événements aux inputs
            addQuantityInputListeners();
        }

        // Fonction séparée pour ajouter des écouteurs aux inputs de quantité
        function addQuantityInputListeners() {
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', function() {
                    const cardId = parseInt(this.getAttribute('data-card-id'));
                    const accountIndex = parseInt(this.getAttribute('data-account-index'));
                    const newValue = parseInt(this.value) || 0;
                    
                    updateQuantity(cardId, accountIndex, newValue);
                });
            });
        }

        // Fonction pour mettre à jour la quantité d'une carte
        function updateQuantity(cardId, accountIndex, newValue) {
            cards = cards.map(card => {
                if (card.id === cardId) {
                    const newQuantities = [...card.quantities];
                    newQuantities[accountIndex] = newValue;
                    return { ...card, quantities: newQuantities };
                }
                return card;
            });
            
            // Mettre à jour les statistiques
            updateStatistics();
            
            // Rafraîchir l'affichage des cartes pour mettre à jour les indicateurs d'échange
            renderCards();
        }

        // Fonction mise à jour pour les statistiques
        function updateStatistics() {
            const container = document.getElementById('statistics');
            container.innerHTML = '';
            
            // Créer un conteneur flex pour l'affichage horizontal
            const flexContainer = document.createElement('div');
            flexContainer.className = 'flex flex-wrap justify-center gap-4';
            container.appendChild(flexContainer);
            
            // Calculer les cartes uniques possédées par compte
            const uniqueCardsByAccount = accounts.map((_, index) => {
                return cards.filter(card => card.quantities[index] > 0).length;
            });
            
            // Afficher les statistiques pour chaque compte
            accounts.forEach((account, index) => {
                const div = document.createElement('div');
                div.className = 'text-center bg-white p-3 rounded shadow';
                
                // Calculer les cartes avec exemplaires en trop
                const extraCards = cards.filter(card => card.quantities[index] > 1).length;
                
                // Calculer les cartes manquantes
                const missingCards = cards.filter(card => card.quantities[index] === 0).length;
                
                // Calculer les cartes échangeables (extra pour ce compte ET manquantes pour au moins un autre)
                const exchangeableCards = cards.filter(card => {
                    return card.quantities[index] > 1 && // Ce compte a des extras
                           accounts.some((_, otherIndex) => otherIndex !== index && card.quantities[otherIndex] === 0); // Un autre compte en a besoin
                }).length;
                
                div.innerHTML = `
                    <div class="font-medium">${account}</div>
                    <div class="text-xl font-bold">${uniqueCardsByAccount[index]}/${cards.length}</div>
                    <div class="text-sm mt-1">
                        <div class="flex justify-between">
                            <span>Manquantes:</span>
                            <span class="font-medium text-blue-600">${missingCards}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Doublons:</span>
                            <span class="font-medium text-green-600">${extraCards}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Échangeables:</span>
                            <span class="font-medium text-purple-600">${exchangeableCards}</span>
                        </div>
                    </div>
                `;
                flexContainer.appendChild(div);
            });
            
            // Ajouter des statistiques globales
            const exchangeablePairs = cards.filter(card => {
                const hasExtraInSomeAccount = card.quantities.some(qty => qty > 1);
                const isMissingInSomeAccount = card.quantities.some(qty => qty === 0);
                return hasExtraInSomeAccount && isMissingInSomeAccount;
            }).length;
            
            const globalStats = document.createElement('div');
            globalStats.className = 'w-full text-center mt-4';
            globalStats.innerHTML = `
                <div class="inline-block bg-indigo-100 p-2 rounded border border-indigo-200">
                    <span class="font-medium">Échanges possibles:</span>
                    <span class="font-bold text-indigo-600 ml-2">${exchangeablePairs} cartes</span>
                </div>
            `;
            container.appendChild(globalStats);
        }

        // Fonction pour ajouter une légende expliquant les indicateurs d'échange
        function renderLegend() {
            const infoDiv = document.getElementById('cardsInfo');
            
            // Créer un conteneur pour la légende
            const legendDiv = document.createElement('div');
            legendDiv.className = 'mt-2 text-sm flex flex-wrap gap-4 justify-center';
            
            // Ajouter les explications pour les indicateurs
            legendDiv.innerHTML = `
                <div class="flex items-center">
                    <span class="inline-block w-4 h-4 bg-green-100 border border-green-300 mr-1"></span>
                    <span>Peut donner (doublons)</span>
                </div>
                <div class="flex items-center">
                    <span class="inline-block w-4 h-4 bg-blue-100 border border-blue-300 mr-1"></span>
                    <span>Besoin (manquantes)</span>
                </div>
                <div class="flex items-center">
                    <span class="inline-block mr-1 text-green-600">⟷</span>
                    <span>Échange possible</span>
                </div>
                <div class="flex items-center">
                    <span class="inline-block bg-yellow-200 text-yellow-800 px-2 py-1 rounded text-xs font-bold mr-1">OR</span>
                    <span>Carte OR</span>
                </div>
            `;
            
            // Insérer la légende après les informations des cartes
            infoDiv.parentNode.insertBefore(legendDiv, infoDiv.nextSibling);
        }

        // Fonction pour définir le filtre actif
        function setActiveFilter(filter) {
            currentFilter = filter;
            
            // Mettre à jour l'apparence des boutons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500');
                btn.classList.add('bg-gray-500');
            });
            
            const activeButton = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
            if (activeButton) {
                activeButton.classList.remove('bg-gray-500');
                activeButton.classList.add('bg-blue-500');
            }
            
            // Mettre à jour l'affichage des cartes
            renderCards();
        }

        // Fonction pour ajouter tous les écouteurs d'événements
        function addEventListeners() {
            // Boutons existants
            document.getElementById('saveButton').addEventListener('click', saveData);
            document.getElementById('loadButton').addEventListener('click', loadData);
            
            // Boutons pour les nouveaux comptes
            document.getElementById('addAccountBtn').addEventListener('click', function() {
                const input = document.getElementById('newAccountName');
                const name = input.value.trim();
                
                if (name !== '') {
                    accounts = addAccount(name);
                    input.value = '';
                    renderAccounts();
                    renderAccountButtons();
                    adjustQuantities();
                    renderCards();
                    updateStatistics();
                }
            });
            
            // Écouteur pour la touche Entrée dans le champ de texte
        document.getElementById('newAccountName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('addAccountBtn').click();
            }
        });
        
        // Ajouter des écouteurs pour les boutons de filtre
        document.getElementById('filterAll').addEventListener('click', function() {
            setActiveFilter('all');
        });
        
        document.getElementById('filterExchangeable').addEventListener('click', function() {
            setActiveFilter('exchangeable');
        });
        
        document.getElementById('filterMissing').addEventListener('click', function() {
            setActiveFilter('missing');
        });
        
        // Boutons d'exportation et d'importation
        document.getElementById('exportDataBtn').addEventListener('click', showExportDialog);
        document.getElementById('importDataBtn').addEventListener('click', showImportDialog);
        
        // Ajouter des écouteurs pour les inputs de quantité
        addQuantityInputListeners();
    }

    // Fonction pour sauvegarder les données
    function saveData() {
        const data = {
            cards: cards,
            lastUpdate: new Date().toISOString()
        };
        
        localStorage.setItem('cardsManagerData', JSON.stringify(data));
        alert('Données sauvegardées avec succès !');
    }

    // Fonction pour charger les données
    function loadData() {
        const savedData = localStorage.getItem('cardsManagerData');
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                cards = data.cards;
                
                // Vérifier si le nombre de comptes a changé depuis la sauvegarde
                if (cards.length > 0 && cards[0].quantities.length !== accounts.length) {
                    adjustQuantities();
                }
                
                renderCards();
                updateStatistics();
                alert('Données chargées avec succès !');
            } catch (e) {
                console.error('Erreur lors du chargement des données:', e);
                alert('Erreur lors du chargement des données.');
            }
        } else {
            alert('Aucune donnée sauvegardée trouvée.');
        }
    }

    // Fonction pour générer un code d'export des données
    function generateExportCode() {
        try {
            // Préparer les données
            const dataToExport = {
                accounts: accounts,
                cards: cards,
                timestamp: new Date().toISOString()
            };
            
            // Convertir en JSON et encoder en base64
            const jsonData = JSON.stringify(dataToExport);
            const base64Data = btoa(unescape(encodeURIComponent(jsonData)));
            
            return base64Data;
        } catch (error) {
            console.error('Erreur lors de la génération du code d\'export:', error);
            return null;
        }
    }

    // Fonction pour importer des données à partir d'un code
    function importFromCode(code) {
        if (!code || code.trim() === '') {
            alert('Aucun code n\'a été fourni.');
            return false;
        }
        
        try {
            // Décoder les données base64 et parser le JSON
            const jsonData = decodeURIComponent(escape(atob(code.trim())));
            const importedData = JSON.parse(jsonData);
            
            if (!importedData.accounts || !importedData.cards) {
                alert('Le code d\'import est invalide ou corrompu.');
                return false;
            }
            
            // Mettre à jour les données locales
            accounts = importedData.accounts;
            cards = importedData.cards;
            
            // Sauvegarder les données et mettre à jour l'interface
            saveAccounts(accounts);
            saveData();
            renderAccounts();
            renderAccountButtons();
            renderCards();
            updateStatistics();
            
            return true;
        } catch (error) {
            console.error('Erreur lors de l\'import des données:', error);
            alert('Le code d\'import est invalide ou corrompu.');
            return false;
        }
    }

    // Fonction pour afficher le dialogue d'export
    function showExportDialog() {
        const exportCode = generateExportCode();
        
        if (!exportCode) {
            alert('Une erreur s\'est produite lors de la génération du code d\'export.');
            return;
        }
        
        // Créer l'overlay de dialogue
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        overlay.style.zIndex = '1000';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        
        // Créer la boîte de dialogue
        const dialog = document.createElement('div');
        dialog.style.backgroundColor = '#fff';
        dialog.style.padding = '20px';
        dialog.style.borderRadius = '8px';
        dialog.style.maxWidth = '600px';
        dialog.style.width = '90%';
        dialog.style.maxHeight = '80vh';
        dialog.style.overflowY = 'auto';
        
        // Contenu du dialogue
        dialog.innerHTML = `
            <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 15px;">Code d'export de données</h2>
            <p style="margin-bottom: 15px;">
                Copiez ce code et enregistrez-le. Vous pourrez l'utiliser sur un autre appareil 
                pour importer vos données.
            </p>
            <div style="position: relative; margin-bottom: 20px;">
                <textarea id="exportCodeArea" 
                    style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; 
                           border-radius: 4px; font-family: monospace; font-size: 12px;"
                    readonly>${exportCode}</textarea>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <button id="copyCodeBtn" 
                    style="padding: 8px 16px; background-color: #3b82f6; color: white; 
                           border: none; border-radius: 4px; cursor: pointer;">
                    Copier le code
                </button>
                <button id="closeDialogBtn" 
                    style="padding: 8px 16px; background-color: #6b7280; color: white; 
                           border: none; border-radius: 4px; cursor: pointer;">
                    Fermer
                </button>
            </div>
        `;
        
        // Ajouter la boîte de dialogue à l'overlay, puis à la page
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        
        // Ajouter les écouteurs d'événements pour les boutons
        document.getElementById('copyCodeBtn').addEventListener('click', function() {
            const textarea = document.getElementById('exportCodeArea');
            textarea.select();
            document.execCommand('copy');
            this.textContent = 'Copié !';
            this.style.backgroundColor = '#10b981';
            setTimeout(() => {
                this.textContent = 'Copier le code';
                this.style.backgroundColor = '#3b82f6';
            }, 2000);
        });
        
        document.getElementById('closeDialogBtn').addEventListener('click', function() {
            document.body.removeChild(overlay);
        });
        
        // Sélectionner automatiquement le texte du code
        const textarea = document.getElementById('exportCodeArea');
        textarea.focus();
        textarea.select();
    }

    // Fonction pour afficher le dialogue d'import
    function showImportDialog() {
        // Créer l'overlay de dialogue
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        overlay.style.zIndex = '1000';
        overlay.style.display = 'flex';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        
        // Créer la boîte de dialogue
        const dialog = document.createElement('div');
        dialog.style.backgroundColor = '#fff';
        dialog.style.padding = '20px';
        dialog.style.borderRadius = '8px';
        dialog.style.maxWidth = '600px';
        dialog.style.width = '90%';
        
        // Contenu du dialogue
        dialog.innerHTML = `
            <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 15px;">Importer des données</h2>
            <p style="margin-bottom: 15px;">
                Collez le code d'export que vous avez précédemment généré sur un autre appareil.
            </p>
            <div style="margin-bottom: 20px;">
                <textarea id="importCodeArea" 
                    style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; 
                           border-radius: 4px; font-family: monospace; font-size: 12px;"
                    placeholder="Collez votre code d'import ici..."></textarea>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <button id="importBtn" 
                    style="padding: 8px 16px; background-color: #10b981; color: white; 
                           border: none; border-radius: 4px; cursor: pointer;">
                    Importer
                </button>
                <button id="cancelImportBtn" 
                    style="padding: 8px 16px; background-color: #6b7280; color: white; 
                           border: none; border-radius: 4px; cursor: pointer;">
                    Annuler
                </button>
            </div>
        `;
        
        // Ajouter la boîte de dialogue à l'overlay, puis à la page
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        
        // Ajouter les écouteurs d'événements pour les boutons
        document.getElementById('importBtn').addEventListener('click', function() {
            const code = document.getElementById('importCodeArea').value;
            if (code.trim() === '') {
                alert('Veuillez coller un code d\'import valide.');
                return;
            }
            
            // Confirmation avant import
            if (confirm('Cette action remplacera toutes vos données actuelles. Êtes-vous sûr de vouloir continuer ?')) {
                const success = importFromCode(code);
                if (success) {
                    alert('Données importées avec succès !');
                    document.body.removeChild(overlay);
                }
            }
        });
        
        document.getElementById('cancelImportBtn').addEventListener('click', function() {
            document.body.removeChild(overlay);
        });
        
        // Mettre le focus sur la zone de texte
        document.getElementById('importCodeArea').focus();
    }

    // Initialiser lors du chargement de la page
    document.addEventListener('DOMContentLoaded', init);
</script>

<!-- Script des données de cartes (à inclure ou à référencer) -->
<script src="js/cardsData.js"></script>
</body>
</html>